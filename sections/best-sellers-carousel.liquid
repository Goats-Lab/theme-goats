{% comment %}
  Best Sellers Carousel — MyCharms (estética clean & premium)
  Dica: ordene a coleção por "Mais vendidos" no admin para refletir corretamente.
{% endcomment %}

<section class="mc-lx">
  <div class="mc-lx__head">
    {% if section.settings.subtitle != blank %}
      <span class="mc-lx__kicker">{{ section.settings.subtitle }}</span>
    {% endif %}
    {% if section.settings.title != blank %}
      <h2 class="mc-lx__title">{{ section.settings.title }}</h2>
    {% endif %}
  </div>

  {% assign coll = collections[section.settings.collection] %}
  {% if coll and coll.products_count > 0 %}
    <div class="mc-lx__rail-wrap">
      {% if section.settings.show_arrows %}
        <button class="mc-lx__arrow mc-lx__arrow--prev" aria-label="Anterior" data-dir="-1">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
        </button>
        <button class="mc-lx__arrow mc-lx__arrow--next" aria-label="Próximo" data-dir="1">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
        </button>
      {% endif %}

      <div class="mc-lx__rail" id="rail-{{ section.id }}" tabindex="0" aria-label="Carrossel dos mais vendidos">
        {% for product in coll.products limit: section.settings.limit %}
          <article class="mc-lx__card snap-start">
            <a class="mc-lx__imglink" href="{{ product.url }}">
              <div class="mc-lx__media">
                {% assign fm = product.featured_media %}
                {% if fm %}
                  {{ fm | image_url: width: 1100 | image_tag:
                    loading: 'lazy',
                    widths: '480,720,960,1100',
                    sizes: '(max-width: 749px) 72vw, 24vw',
                    alt: product.title,
                    class: 'mc-lx__img' }}
                {% else %}
                  <div class="mc-lx__ph">MyCharms</div>
                {% endif %}
                {% if product.compare_at_price > product.price %}
                  <span class="mc-lx__badge">promo</span>
                {% endif %}
              </div>
            </a>

            <div class="mc-lx__info">
              <h3 class="mc-lx__name"><a href="{{ product.url }}">{{ product.title }}</a></h3>

              <div class="mc-lx__price">
                <span class="now">
                  {% if product.price_varies %}
                    {{ 'products.product.from_text_html' | t: price: product.price | money }}
                  {% else %}
                    {{ product.price | money }}
                  {% endif %}
                </span>
                {% if product.compare_at_price > product.price %}
                  <span class="was">{{ product.compare_at_price | money }}</span>
                {% endif %}
              </div>

              {% if section.settings.show_quick_add and product.available %}
                <button class="mc-lx__btn" data-handle="{{ product.handle }}">Adicionar ao carrinho</button>
              {% else %}
                <a class="mc-lx__btn mc-lx__btn--ghost" href="{{ product.url }}">Ver detalhes</a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    </div>

    {% if section.settings.show_dots %}
      <div class="mc-lx__dots" id="dots-{{ section.id }}"></div>
    {% endif %}

    {% if section.settings.show_view_all and coll.url %}
      <div class="mc-lx__cta">
        <a class="mc-lx__all" href="{{ coll.url }}{% if section.settings.force_best_selling_link %}?sort_by=best-selling{% endif %}">Ver todos</a>
      </div>
    {% endif %}
  {% else %}
    <p class="mc-lx__empty">Selecione uma coleção com produtos.</p>
  {% endif %}

  <style>
    /* —— Design tokens MyCharms (suave e elegante) —— */
    :root{
      --mc-ink:#111111;
      --mc-muted:#6b7280;
      --mc-hair:rgba(17,17,17,.08);
      --mc-soft:rgba(17,17,17,.04);
      --mc-surface:#ffffff;
      --mc-pink:#ff9ccd;        /* MyCharms */
      --mc-pink-ink:#7d3d5a;    /* contraste elegante p/ hover */
    }

    .mc-lx{ padding:28px 0 8px; color:var(--mc-ink); }
    .mc-lx__head{ text-align:center; margin:0 16px 14px; }
    .mc-lx__kicker{
      display:inline-block; font-size:.78rem; letter-spacing:.14em; text-transform:uppercase;
      color:var(--mc-muted);
    }
    .mc-lx__title{
      margin:.35rem 0 0; font-feature-settings:"ss01" on, "liga" on;
      font-size:clamp(1.3rem,2.4vw,1.75rem); font-weight:600;
    }

    /* —— Carrossel —— */
    .mc-lx__rail-wrap{ position:relative; }
    .mc-lx__rail{
      display:grid; grid-auto-flow:column; grid-auto-columns:minmax(68%,1fr);
      gap:16px; overflow:auto; overscroll-behavior-x:contain; scroll-snap-type:x mandatory;
      scroll-padding:16px; padding:4px 16px 8px; -webkit-overflow-scrolling:touch;
    }
    @media (min-width:560px){ .mc-lx__rail{ grid-auto-columns:minmax(44%,1fr); } }
    @media (min-width:990px){ .mc-lx__rail{ grid-auto-columns:minmax(24%,1fr); } }

    /* —— Card minimalista —— */
    .mc-lx__card{
      background:var(--mc-surface);
      border:1px solid var(--mc-hair);
      border-radius:20px; overflow:hidden;
      scroll-snap-align:start;
      box-shadow:0 1px 0 var(--mc-soft);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .mc-lx__card:hover{
      transform:translateY(-1px);
      border-color:rgba(17,17,17,.10);
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }

    .mc-lx__media{
      position:relative; aspect-ratio:1/1;
      background:linear-gradient(180deg,#fff 0%, #fafafb 100%);
      border-bottom:1px solid var(--mc-soft);
    }
    .mc-lx__img{ width:100%; height:100%; object-fit:contain; display:block; transform:translateZ(0); transition:transform .25s ease; }
    .mc-lx__card:hover .mc-lx__img{ transform:scale(1.02); }
    .mc-lx__ph{ width:100%; height:100%; display:grid; place-items:center; color:var(--mc-muted); font-size:.9rem; letter-spacing:.08em; }

    .mc-lx__badge{
      position:absolute; top:12px; left:12px;
      font-size:.68rem; letter-spacing:.12em; text-transform:lowercase;
      background:#fff; color:var(--mc-pink-ink);
      border:1px solid rgba(125,61,90,.22);
      padding:.24rem .46rem; border-radius:999px;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }

    .mc-lx__info{ padding:12px 14px 16px; }
    .mc-lx__name{ margin:0 0 .45rem; font-size:.95rem; line-height:1.35; font-weight:500; }
    .mc-lx__name a{ color:inherit; text-decoration:none; }
    .mc-lx__name a:hover{ text-decoration:underline; text-underline-offset:3px; }

    .mc-lx__price{ display:flex; align-items:baseline; gap:.5rem; }
    .mc-lx .now{ font-weight:700; }
    .mc-lx .was{ text-decoration:line-through; opacity:.55; }

    /* —— Botões elegantes —— */
    .mc-lx__btn{
      margin-top:.7rem; width:100%;
      border:1px solid var(--mc-ink); background:transparent; color:var(--mc-ink);
      padding:.65rem .9rem; border-radius:14px; font-size:.8rem; letter-spacing:.08em; text-transform:uppercase;
      transition: background .18s ease, color .18s ease, border-color .18s ease;
    }
    .mc-lx__btn:hover{ background:var(--mc-ink); color:#fff; }
    .mc-lx__btn--ghost{
      background:transparent; border:1px solid var(--mc-hair); color:var(--mc-ink);
      text-align:center; display:block;
    }
    .mc-lx__btn--ghost:hover{ border-color:var(--mc-ink); }

    /* —— Setas minimalistas —— */
    .mc-lx__arrow{
      position:absolute; top:50%; transform:translateY(-50%);
      width:40px; height:40px; border-radius:999px;
      border:1px solid var(--mc-hair); background:#fff;
      display:grid; place-items:center; color:#333;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      cursor:pointer; z-index:2; transition:background .18s, border-color .18s, box-shadow .18s;
    }
    .mc-lx__arrow:hover{ background:#fff; border-color:rgba(17,17,17,.12); box-shadow:0 6px 20px rgba(0,0,0,.08); }
    .mc-lx__arrow--prev{ left:8px; }
    .mc-lx__arrow--next{ right:8px; }

    /* —— Dots discretos —— */
    .mc-lx__dots{ display:flex; gap:6px; justify-content:center; margin:12px 0 0; }
    .mc-lx__dot{ width:6px; height:6px; border-radius:999px; background:rgba(17,17,17,.12); transition:transform .18s, background .18s, box-shadow .18s; }
    .mc-lx__dot.is-active{ background:var(--mc-pink); box-shadow:0 0 0 6px rgba(255,156,205,.18); transform:scale(1.05); }

    .mc-lx__cta{ text-align:center; margin:16px 0 0; }
    .mc-lx__all{
      display:inline-block; padding:.7rem 1.1rem; border:1px solid var(--mc-hair); border-radius:14px; text-decoration:none; color:var(--mc-ink);
    }
    .mc-lx__all:hover{ border-color:var(--mc-ink); }

    /* Acessibilidade */
    .mc-lx__rail:focus-visible{ outline:2px solid var(--mc-pink); outline-offset:2px; }
  </style>

  {% if coll and coll.products_count > 0 %}
  <script>
    (function(){
      const rail = document.getElementById('rail-{{ section.id }}');
      if(!rail) return;

      // Arraste mouse/touch
      let isDown=false, startX=0, scrollL=0;
      const start = x => { isDown=true; startX=x; scrollL=rail.scrollLeft; rail.classList.add('dragging'); };
      const move  = x => { if(!isDown) return; rail.scrollLeft = scrollL - (x - startX); };
      const end   = () => { isDown=false; rail.classList.remove('dragging'); };
      rail.addEventListener('mousedown',e=>{ if(e.button!==0) return; start(e.pageX); });
      window.addEventListener('mousemove',e=>move(e.pageX));
      window.addEventListener('mouseup',end);
      rail.addEventListener('touchstart',e=>start(e.touches[0].clientX),{passive:true});
      rail.addEventListener('touchmove',e=>move(e.touches[0].clientX),{passive:true});
      rail.addEventListener('touchend',end);

      // Setas
      const wrap = rail.parentElement;
      wrap.querySelectorAll('.mc-lx__arrow').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const dir = parseInt(btn.dataset.dir,10) || 1;
          const step = Math.max(rail.clientWidth * {{ section.settings.scroll_step | divided_by: 100.0 }}, 200);
          rail.scrollBy({ left: step * dir, behavior:'smooth' });
        });
      });

      // Dots
      {% if section.settings.show_dots %}
      const dotsWrap = document.getElementById('dots-{{ section.id }}');
      const GAP = 16;
      const cardW = () => rail.querySelector('.mc-lx__card')?.getBoundingClientRect().width || 300;
      const perView = () => Math.max(1, Math.round(rail.clientWidth / (cardW()+GAP)));
      const pages = () => Math.ceil(rail.children.length / perView());
      const renderDots = ()=>{
        const n = pages(); dotsWrap.innerHTML='';
        for(let i=0;i<n;i++){ const d=document.createElement('span'); d.className='mc-lx__dot'; d.dataset.index=i; dotsWrap.appendChild(d); }
        activate();
      };
      const activate = ()=>{
        const idx = Math.round(rail.scrollLeft / (cardW()+GAP));
        const pv = perView();
        const page = Math.min(pages()-1, Math.round(idx / pv));
        dotsWrap.querySelectorAll('.mc-lx__dot').forEach((el,i)=>el.classList.toggle('is-active', i===page));
      };
      renderDots();
      rail.addEventListener('scroll', ()=>requestAnimationFrame(activate));
      window.addEventListener('resize', renderDots);
      dotsWrap?.addEventListener('click', e=>{
        const dot = e.target.closest('.mc-lx__dot'); if(!dot) return;
        const pv = perView(); const target = (parseInt(dot.dataset.index,10)||0) * pv;
        const x = target * (cardW()+GAP);
        rail.scrollTo({left:x, behavior:'smooth'});
      });
      {% endif %}

      // Quick add
      {% if section.settings.show_quick_add %}
      document.addEventListener('click', async (e)=>{
        const b = e.target.closest('.mc-lx__btn[data-handle]'); if(!b) return;
        b.disabled=true; const t=b.textContent; b.textContent='Adicionando…';
        try{
          const h=b.dataset.handle;
          const pj=await fetch(`/products/${h}.js`).then(r=>r.json());
          const v = pj.variants.find(v=>v.available) || pj.variants[0];
          const ok = await fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:v.id,quantity:1})});
          if(!ok.ok) throw 0;
          b.textContent='Adicionado!';
        }catch(_){ b.textContent='Erro'; }
        finally{ setTimeout(()=>{ b.textContent=t; b.disabled=false; }, 1200); }
      });
      {% endif %}

      // Autoplay (pausa no hover)
      {% if section.settings.autoplay %}
      let at = setInterval(()=>{ rail.scrollBy({left: rail.clientWidth * {{ section.settings.scroll_step | divided_by: 100.0 }}, behavior:'smooth'}); }, {{ section.settings.autoplay_ms }});
      rail.addEventListener('mouseenter', ()=>clearInterval(at));
      rail.addEventListener('mouseleave', ()=> at = setInterval(()=>{ rail.scrollBy({left: rail.clientWidth * {{ section.settings.scroll_step | divided_by: 100.0 }}, behavior:'smooth'}); }, {{ section.settings.autoplay_ms }}));
      {% endif %}
    })();
  </script>
  {% endif %}
</section>

{% schema %}
{
  "name": "Mais vendidos — MyCharms",
  "settings": [
    { "type": "text", "id": "subtitle", "label": "Subtítulo", "default": "TOP VENDIDOS" },
    { "type": "text", "id": "title", "label": "Título", "default": "Favoritos da MyCharms" },
    { "type": "collection", "id": "collection", "label": "Coleção" },

    { "type": "range", "id": "limit", "label": "Qtd. de itens", "min": 4, "max": 20, "step": 1, "default": 12 },

    { "type": "checkbox", "id": "show_arrows", "label": "Mostrar setas", "default": true },
    { "type": "checkbox", "id": "show_dots", "label": "Mostrar bolinhas (páginas)", "default": true },
    { "type": "checkbox", "id": "show_quick_add", "label": "Botão Adicionar rápido", "default": true },
    { "type": "checkbox", "id": "show_view_all", "label": "Mostrar botão \"Ver todos\"", "default": true },
    { "type": "checkbox", "id": "force_best_selling_link", "label": "Forçar ?sort_by=best-selling no link", "default": true },

    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": false },
    {
      "type": "select",
      "id": "autoplay_ms",
      "label": "Velocidade autoplay (ms)",
      "default": "4000",
      "options": [
        { "value": "2500", "label": "2,5 s" },
        { "value": "3000", "label": "3 s" },
        { "value": "4000", "label": "4 s" },
        { "value": "5000", "label": "5 s" },
        { "value": "8000", "label": "8 s" },
        { "value": "9000", "label": "9 s" }
      ]
    },
    { "type": "range", "id": "scroll_step", "label": "Avanço por clique (% da largura)", "min": 30, "max": 100, "step": 5, "default": 85 }
  ],
  "presets": [
    { "name": "Mais vendidos (Carrossel) — MyCharms", "category": "Produtos" }
  ]
}
{% endschema %}
