{% comment %}
  Section: Best Sellers (Mais vendidos)
  Como usar:
  1) Salve este arquivo como sections/best-sellers.liquid
  2) No Editor do Tema, adicione a se√ß√£o ‚ÄúMais vendidos‚Äù e escolha a cole√ß√£o.
  3) No admin da Shopify, defina a cole√ß√£o escolhida com "Ordenar = Mais vendidos".
{% endcomment %}

<section class="mc-bestsellers color-scheme color-scheme--scheme-1">
  <div class="mc-bs__container">
    {% if section.settings.subtitle != blank %}
      <p class="mc-bs__subtitle">{{ section.settings.subtitle }}</p>
    {% endif %}
    {% if section.settings.title != blank %}
      <h2 class="mc-bs__title">{{ section.settings.title }}</h2>
    {% endif %}

    {% assign coll = collections[section.settings.collection] %}
    {% if coll and coll.products_count > 0 %}
      <ul class="mc-bs__grid">
        {% for product in coll.products limit: section.settings.limit %}
          <li class="mc-bs__item">
            <a class="mc-bs__card" href="{{ product.url }}">
              <div class="mc-bs__media">
                {% assign featured = product.featured_media %}
                {% if featured %}
                  {{ featured | image_url: width: 720 | image_tag:
                    loading: 'lazy',
                    widths: '360,540,720',
                    sizes: '(max-width: 699px) 50vw, 25vw',
                    alt: product.title,
                    class: 'mc-bs__img' }}
                {% else %}
                  <div class="mc-bs__placeholder">{{ 'products.product' | t }}</div>
                {% endif %}
                {% if product.compare_at_price > product.price %}
                  <span class="mc-bs__badge">Promo</span>
                {% endif %}
              </div>

              <div class="mc-bs__info">
                {% if section.settings.show_vendor and product.vendor %}
                  <span class="mc-bs__vendor">{{ product.vendor }}</span>
                {% endif %}

                <h3 class="mc-bs__name">{{ product.title }}</h3>

                <div class="mc-bs__price">
                  <span class="mc-bs__price-current">
                    {% if product.price_varies %}
                      {{ 'products.product.from_text_html' | t: price: product.price | money }}
                    {% else %}
                      {{ product.price | money }}
                    {% endif %}
                  </span>
                  {% if product.compare_at_price > product.price %}
                    <span class="mc-bs__price-compare">{{ product.compare_at_price | money }}</span>
                  {% endif %}
                </div>

                {% if section.settings.show_quick_add and product.available %}
                  <button type="button"
                          class="mc-bs__quickadd"
                          data-product-handle="{{ product.handle }}"
                          aria-label="Adicionar {{ product.title }} ao carrinho">
                    Adicionar
                  </button>
                {% endif %}
              </div>
            </a>
          </li>
        {% endfor %}
      </ul>

      {% if section.settings.show_view_all and coll.url %}
        <div class="mc-bs__cta">
          <a class="mc-bs__button" href="{{ coll.url }}{% if section.settings.force_best_selling_link %}?sort_by=best-selling{% endif %}">
            Ver todos
          </a>
        </div>
      {% endif %}
    {% else %}
      <p class="mc-bs__empty">Selecione uma cole√ß√£o com produtos.</p>
    {% endif %}
  </div>

  <style>
    .mc-bestsellers { padding: 2.5rem 1rem; }
    .mc-bs__container { max-width: 1200px; margin: 0 auto; }
    .mc-bs__subtitle { text-transform: uppercase; letter-spacing: .12em; font-size: .8rem; opacity: .8; text-align:center; margin-bottom:.25rem; }
    .mc-bs__title { text-align:center; font-size: clamp(1.25rem, 2.5vw, 1.75rem); margin: 0 0 1.25rem; }
    .mc-bs__grid {
      list-style: none; display: grid; gap: 16px; padding: 0; margin: 0;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (min-width: 700px) { .mc-bs__grid { grid-template-columns: repeat(4, minmax(0,1fr)); } }
    .mc-bs__item { }
    .mc-bs__card { display:block; text-decoration:none; color: inherit; border: 1px solid rgba(0,0,0,.08); padding: 10px; transition: transform .2s ease, box-shadow .2s ease; background: #fff; }
    .mc-bs__card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .mc-bs__media { position: relative; aspect-ratio: 1/1; overflow:hidden; background:#f7f7f7; }
    .mc-bs__img { width:100%; height:100%; object-fit:contain; display:block; }
    .mc-bs__badge {
      position:absolute; top:10px; left:10px; background:#e53935; color:#fff; font-size:.7rem; padding:.25rem .4rem; letter-spacing:.06em;
    }
    .mc-bs__info { padding-top: .65rem; }
    .mc-bs__vendor { display:block; font-size:.75rem; opacity:.7; margin-bottom:.15rem; }
    .mc-bs__name { font-size:.95rem; line-height:1.3; margin:.1rem 0 .4rem; }
    .mc-bs__price { display:flex; align-items:baseline; gap:.5rem; }
    .mc-bs__price-current { font-weight:600; }
    .mc-bs__price-compare { text-decoration: line-through; opacity:.55; font-size:.9rem; }
    .mc-bs__cta { margin-top: 1rem; text-align: center; }
    .mc-bs__button {
      display:inline-block; padding:.7rem 1.1rem; border:1px solid #111; text-transform:uppercase; letter-spacing:.12em; font-size:.8rem;
    }
    .mc-bs__empty { text-align:center; opacity:.7; }
    .mc-bs__quickadd {
      margin-top:.6rem; width:100%; border:1px solid #111; background:#111; color:#fff; padding:.55rem .8rem;
      text-transform: uppercase; letter-spacing:.12em; font-size:.72rem;
    }
  </style>

  {% if section.settings.show_quick_add %}
    <script>
      // Quick Add simples (adiciona primeiro variant dispon√≠vel)
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.mc-bs__quickadd');
        if (!btn) return;

        btn.disabled = true; const original = btn.textContent; btn.textContent = 'Adicionando...';
        try {
          const handle = btn.dataset.productHandle;
          const res = await fetch(`/products/${handle}.js`);
          const product = await res.json();
          const firstAvailable = product.variants.find(v => v.available) || product.variants[0];
          const cartRes = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: firstAvailable.id, quantity: 1 })
          });
          if (!cartRes.ok) throw new Error('Erro ao adicionar');
          btn.textContent = 'Adicionado!';
        } catch (err) {
          console.error(err);
          btn.textContent = 'Erro üòï';
        } finally {
          setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1200);
        }
      });
    </script>
  {% endif %}
</section>

{% schema %}
{
  "name": "Mais vendidos",
  "settings": [
    { "type": "text", "id": "subtitle", "label": "Subt√≠tulo", "default": "TOP VENDIDOS" },
    { "type": "text", "id": "title", "label": "T√≠tulo", "default": "Mais vendidos" },
    { "type": "collection", "id": "collection", "label": "Cole√ß√£o" },
    { "type": "range", "id": "limit", "label": "Quantidade de produtos", "min": 4, "max": 12, "step": 1, "default": 8 },
    { "type": "checkbox", "id": "show_vendor", "label": "Mostrar marca (vendor)", "default": false },
    { "type": "checkbox", "id": "show_view_all", "label": "Mostrar bot√£o ‚ÄúVer todos‚Äù", "default": true },
    { "type": "checkbox", "id": "force_best_selling_link", "label": "For√ßar par√¢metro ?sort_by=best-selling no link ‚ÄúVer todos‚Äù", "default": true },
    { "type": "checkbox", "id": "show_quick_add", "label": "Ativar bot√£o Adicionar r√°pido", "default": true }
  ],
  "presets": [
    { "name": "Mais vendidos", "category": "Produtos" }
  ]
}
{% endschema %}
